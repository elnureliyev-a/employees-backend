"use strict";var Ae=Object.create;var K=Object.defineProperty;var Oe=Object.getOwnPropertyDescriptor;var Ue=Object.getOwnPropertyNames;var Re=Object.getPrototypeOf,We=Object.prototype.hasOwnProperty;var Ve=(o,e)=>{for(var t in e)K(o,t,{get:e[t],enumerable:!0})},we=(o,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Ue(e))!We.call(o,i)&&i!==t&&K(o,i,{get:()=>e[i],enumerable:!(s=Oe(e,i))||s.enumerable});return o};var l=(o,e,t)=>(t=o!=null?Ae(Re(o)):{},we(e||!o||!o.__esModule?K(t,"default",{value:o,enumerable:!0}):t,o)),je=o=>we(K({},"__esModule",{value:!0}),o);var He={};Ve(He,{activate:()=>qe,deactivate:()=>Je});module.exports=je(He);var a=l(require("vscode"));var Ee=l(require("child_process")),De=l(require("path"));function x(o){return o?o.stderr?o.stderr:o.error?JSON.stringify(o.error):o instanceof Error?o.message:JSON.stringify(o):"No error provided"}var ae=class extends Error{constructor(t,s,i){super(t.message);this.causedBy=t;this.stdout=s;this.stderr=i}};async function Y(o,e,t={}){return t={...t,maxBuffer:t.maxBuffer??1024*1024*64},new Promise((s,i)=>{Ee.execFile(o,e,t,(r,n,c)=>{r?i(new ae(r,n,c)):s({stdout:n,stderr:c})})})}function de(o,e=process.env.HOME??null,t=process.platform){return t==="win32"||o[0]!=="~"||!e?o:De.join(e,o.slice(1))}var _=l(require("fs/promises")),Ce=l(require("vscode")),D=class o{constructor(e,t){this.path=e;this.version=t||""}version;static async create(){try{let e=await o.getEdgePath(),t=new o(e);return t.version=await t.getVersion(),t}catch(e){console.error("Failed to create EdgeCLI:",x(e));return}}static async getEdgePath(){let t=Ce.workspace.getConfiguration("edgeos").get("cliPath");if(t&&t.trim()!=="")try{let s=de(t);return await _.access(s,_.constants.X_OK),s}catch{throw new Error(`Configured Edge CLI path "${t}" is not accessible or executable.`)}try{let s;switch(process.platform){case"darwin":{let{stdout:r}=await Y("which",["edge"]);s=r.trimEnd();break}default:{let{stdout:r}=await Y("/bin/sh",["-c","LC_MESSAGES=C type edge"]),n=/^edge is (.*)$/.exec(r.trimEnd());if(n)s=n[1];else throw Error("Failed to find edge executable");break}}let i=await _.realpath(s);return de(i)}catch{throw new Error("Failed to find edge executable")}}async exec(e){let{stdout:t}=await Y(this.path,e);return t.trimEnd()}async getVersion(){return await this.exec(["--version"])}};var C=l(require("vscode"));var B=class{constructor(e,t){this.swift=e;this.workspaceContext=t}dispose(){}};var M=l(require("fs")),q=l(require("path")),ke=l(require("util")),xe=require("child_process"),N=class{static EDGE_DEPENDENCY_PATTERNS=["edge-runtime","edge-agent","edge-proxy","apache-edge","apache/edge"];static async isEdgeProject(e){let t=q.join(e,"Package.swift");try{if(M.existsSync(t)){let n=await M.promises.readFile(t,"utf8");for(let c of this.EDGE_DEPENDENCY_PATTERNS)if(n.includes(c))return!0}}catch(r){console.error(`Error checking Package.swift: ${r}`)}let s=q.join(e,".edge"),i=q.join(e,"edge.json");try{if(M.existsSync(s)||M.existsSync(i))return!0}catch(r){console.error(`Error checking for .edge directory or config: ${r}`)}try{let r=ke.promisify(xe.exec),{stdout:n}=await r("edge info",{cwd:e});if(n&&!n.toLowerCase().includes("error"))return!0}catch{}return!1}};var I=l(require("vscode"));var W=l(require("path"));function ye(o,e=!1,t){let s=t==="posix"?W.posix:t==="win32"?W.win32:W,i=e?o.workspaceFolder.uri.fsPath:`\${workspaceFolder:${o.workspaceFolder.name}}`,r,n;return o.relativePath.length===0?(r=i,n=""):(r=s.join(i,o.relativePath),n=` (${o.relativePath})`),{folder:r,nameSuffix:n}}var u=l(require("vscode")),V=l(require("path"));var Pe=require("fs/promises"),Se=l(require("os")),S="edge",ce=4242,Ge="lldb-dap",J=class o{constructor(e,t,s,i){this.outputChannel=e;this.cli=t;this.workspaceContext=s;this.deviceManager=i}async provideDebugConfigurations(e,t){let s=[];for(let i of this.workspaceContext.folders){let r=await i.swift.swiftPackage.executableProducts;for(let n of r)s.push({type:S,name:`Debug ${n.name} on EdgeOS`,request:"attach",target:n.name,cwd:i.swift.folder.fsPath,preLaunchTask:`edge: Run ${n.name}`})}return s}ensureDebugPort(e){if(e.includes(":")){let[t,s]=e.split(":");return s===ce.toString()?e:`${t}:${ce}`}return`${e}:${ce}`}async resolveDebugConfigurationWithSubstitutedVariables(e,t,s){let r=u.workspace.getConfiguration("edgeos").get("swiftSdkPath");if(!r||r.trim()===""){let m=["Configure Swift SDK Path","Cancel"];return await u.window.showErrorMessage("Swift SDK path is not set. This is required for debugging EdgeOS applications.",...m)==="Configure Swift SDK Path"&&await u.commands.executeCommand("edge.configureSwiftSdkPath"),null}try{r.startsWith("~")&&(r=V.join(Se.homedir(),r.slice(1))),r=await(0,Pe.realpath)(r),await u.workspace.fs.stat(u.Uri.file(r))}catch(m){let E=["Configure Swift SDK Path","Cancel"];return await u.window.showErrorMessage(`The configured Swift SDK path "${r}" does not exist: ${x(m)}`,...E)==="Configure Swift SDK Path"&&await u.commands.executeCommand("edge.configureSwiftSdkPath"),null}let n=await this.deviceManager.getCurrentDevice();if(!n){let m=["Add Device","Select Device","Cancel"],E=await u.window.showErrorMessage("No EdgeOS device is selected. You must select a device before debugging.",...m);return E==="Add Device"?await u.commands.executeCommand("edgeDevices.addDevice"):E==="Select Device"&&await u.commands.executeCommand("workbench.view.extension.edge-explorer"),null}let c=V.join(e?.uri.fsPath||"",".edge-build/debug"),h=this.ensureDebugPort(n.address),f=[`settings set target.sdk-path "${V.join(r,"")}"`,`settings set target.swift-module-search-paths "${V.join(r,"6.1-RELEASE_edgeos_aarch64/aarch64-unknown-linux-gnu/debian-bookworm.sdk/usr/lib/swift_static/linux")}"`];return Ge==="lldb-dap"?(t.type="lldb-dap",t.request="attach",t.initCommands=f,t.attachCommands=[`target create ${c}/${t.target}`,`gdb-remote ${h}`]):(t.type="lldb",t.request="launch",t.agent=n.address,t.targetCreateCommands=[`target create ${c}/${t.target}`,...f],t.processCreateCommands=[`gdb-remote ${h}`]),!t.preLaunchTask&&t.target&&(t.preLaunchTask=`edge: Run ${t.target}`),this.outputChannel.appendLine("Resolved debug configuration:"),this.outputChannel.appendLine(JSON.stringify(t,null,2)),t}static register(e,t,s){let i=new o(t,e.cli,e,s),r=u.debug.registerDebugConfigurationProvider(S,i),n=u.debug.registerDebugConfigurationProvider(S,i,u.DebugConfigurationProviderTriggerKind.Dynamic);return[r,n]}};async function H(o){console.log(`[Edge] Checking for debug configurations in folder: ${o.swift.folder.fsPath}`);let e=I.workspace.getConfiguration("launch",o.swift.folder),t=e.get("configurations")||[];if(console.log(`[Edge] Found ${t.length} existing configurations`),t.some(n=>n.type===S))return console.log("[Edge] Edge configurations already exist, skipping"),!1;let i=await Ke(o);if(console.log(`[Edge] Generated ${i.length} new Edge configurations`),i.length===0)return console.log("[Edge] No executable products found, skipping"),!1;let r=[...i,...t];return console.log(`[Edge] Updating launch.json with ${i.length} Edge configurations`),await e.update("configurations",r,I.ConfigurationTarget.WorkspaceFolder),console.log("[Edge] Successfully updated launch.json"),!0}async function Ke(o){console.log(`[Edge] Generating debug configurations for folder: ${o.swift.folder.fsPath}`);let e=await o.swift.swiftPackage.executableProducts;if(console.log(`[Edge] Found ${e.length} executable products`),e.length===0)return[];let{folder:t,nameSuffix:s}=ye(o.swift,void 0,"posix");return console.log(`[Edge] Using folder path: ${t}`),e.map(i=>(console.log(`[Edge] Creating configuration for product: ${i.name}`),{type:S,name:`Debug ${i.name} on EdgeOS`,request:"attach",target:i.name,cwd:t,preLaunchTask:`edge: Run ${i.name}`}))}async function be(){if(console.log("[Edge] Checking if any folder has Edge debug configurations"),!I.workspace.workspaceFolders)return console.log("[Edge] No workspace folders found"),!1;for(let o of I.workspace.workspaceFolders)if(console.log(`[Edge] Checking folder: ${o.name}`),(I.workspace.getConfiguration("launch",o.uri).get("configurations")||[]).some(s=>s.type===S))return console.log(`[Edge] Found Edge configuration in folder: ${o.name}`),!0;return console.log("[Edge] No Edge configurations found in any folder"),!1}var ge={add:"add",remove:"remove",focus:"focus",unfocus:"unfocus",packageUpdated:"packageUpdated",resolvedUpdated:"resolvedUpdated",workspaceStateUpdated:"workspaceStateUpdated",packageViewUpdated:"packageViewUpdated",pluginsUpdated:"pluginsUpdated"};var z=class{constructor(e,t,s,i){this.context=e;this.output=t;this.cli=s;this.swift=i;if(C.workspace.workspaceFolders){console.log(`[Edge] Initial workspace has ${C.workspace.workspaceFolders.length} folders`);for(let r of C.workspace.workspaceFolders)this._initialFolderPaths.add(r.uri.fsPath)}else console.log("[Edge] No initial workspace folders");e.subscriptions.push(this.swift.onDidChangeFolders(r=>this.handleFolderEvent(r))),this._initialFolderSetupTimeout=setTimeout(()=>{console.log("[Edge] Initial folder setup complete (timeout)"),this.markFoldersReady()},5e3),this.onFoldersReady(()=>{console.log("[Edge] Folders ready event handler in EdgeWorkspaceContext"),this.generateLaunchConfigurations()})}folders=[];_onDidChangePackage=new C.EventEmitter;hasEdgeFolder=!1;onDidChangePackage=this._onDidChangePackage.event;_onFoldersReady=new C.EventEmitter;onFoldersReady=this._onFoldersReady.event;_initialFoldersReady=!1;_initialFolderSetupTimeout=null;_initialFolderPaths=new Set;_processedFolderPaths=new Set;_generatedConfigurations=!1;dispose(){this.folders.forEach(e=>e.dispose()),this.folders.length=0,this._onDidChangePackage.dispose(),this._onFoldersReady.dispose(),this._initialFolderSetupTimeout&&clearTimeout(this._initialFolderSetupTimeout)}get initialFoldersReady(){return this._initialFoldersReady}markFoldersReady(){this._initialFoldersReady||(this._initialFoldersReady=!0,console.log(`[Edge] Marking folders as ready, found ${this.folders.length} processed folders`),this._onFoldersReady.fire(),this._initialFolderSetupTimeout&&(clearTimeout(this._initialFolderSetupTimeout),this._initialFolderSetupTimeout=null))}checkAllFoldersProcessed(){this._initialFolderPaths.size===0||this._initialFolderPaths.size===this._processedFolderPaths.size?(console.log(`[Edge] All initial folders processed (${this._processedFolderPaths.size}/${this._initialFolderPaths.size})`),this.markFoldersReady()):console.log(`[Edge] Still waiting for folders: ${this._processedFolderPaths.size}/${this._initialFolderPaths.size}`)}async generateLaunchConfigurations(){if(this._generatedConfigurations){console.log("[Edge] Already generated configurations, skipping");return}this._generatedConfigurations=!0,console.log("[Edge] Starting launch configuration generation from EdgeWorkspaceContext");try{let e=await be();if(console.log(`[Edge] Existing Edge configurations found: ${e}`),!e&&C.workspace.workspaceFolders){console.log(`[Edge] No existing configurations found, checking ${C.workspace.workspaceFolders.length} workspace folders`);for(let t of C.workspace.workspaceFolders){console.log(`[Edge] Checking if folder is an Edge project: ${t.name} (${t.uri.fsPath})`);let s=await N.isEdgeProject(t.uri.fsPath);if(console.log(`[Edge] Is Edge project: ${s} for folder: ${t.name}`),s){this.output.appendLine(`Detected Edge project in folder: ${t.name}`),console.log(`[Edge] Searching for matching EdgeFolderContext in ${this.folders.length} contexts`),this.folders.forEach((r,n)=>{console.log(`[Edge] Context ${n}: ${r.swift.folder.fsPath}`)});let i=!1;for(let r of this.folders)if(console.log(`[Edge] Comparing paths: ${r.swift.folder.fsPath} vs ${t.uri.fsPath}`),r.swift.folder.fsPath===t.uri.fsPath){i=!0,console.log("[Edge] Found matching EdgeFolderContext, generating configurations");let n=await H(r);console.log(`[Edge] makeDebugConfigurations result: ${n}`),n?(this.output.appendLine(`Added Edge debug configurations to ${t.name}`),console.log(`[Edge] Successfully added configurations to ${t.name}`)):(this.output.appendLine(`Edge configurations already exist or couldn't be added for ${t.name}`),console.log(`[Edge] Failed to add configurations to ${t.name}`));break}i||(console.log(`[Edge] No matching EdgeFolderContext found for ${t.name}`),this.output.appendLine(`No EdgeFolderContext found for ${t.name}, cannot create debug configurations`))}}}else console.log(e?"[Edge] Skipping configuration generation as Edge configurations already exist":"[Edge] No workspace folders found, skipping configuration generation")}catch(e){console.error(`[Edge] Error generating launch configurations: ${e}`),this.output.appendLine(`Error generating launch configurations: ${e}`)}}getOrCreateFolderContext(e){let t=this.folders.find(r=>r.swift===e);if(t)return this.hasEdgeFolder=!0,t;let s=new B(e,this);this.folders.push(s);let i=e.folder.fsPath;return this._processedFolderPaths.add(i),console.log(`[Edge] Processed folder: ${i}`),this._initialFolderPaths.has(i)&&this.checkAllFoldersProcessed(),s}async handleFolderEvent({operation:e,workspace:t,folder:s}){if(s)switch(console.log(`[Edge] Folder event: ${e} for ${s.folder.fsPath}`),e){case ge.add:case ge.packageUpdated:{let i=this.getOrCreateFolderContext(s);this._onDidChangePackage.fire(i),this.hasEdgeFolder||this.refreshDebugConfigurations();break}case ge.remove:{let i=this.folders.find(r=>r.swift===s);i&&!this.hasEdgeFolder&&(i.dispose(),this.folders.splice(this.folders.indexOf(i),1),this.refreshDebugConfigurations());break}default:return}}async refreshDebugConfigurations(){await C.window.showInformationMessage("Swift package updated. You may need to refresh debug configurations.","Refresh")==="Refresh"&&C.commands.executeCommand("workbench.action.reloadWindow")}};var p=l(require("vscode"));var g=l(require("vscode"));var A=class{constructor(e,t,s,i,r){this.id=e;this.address=t;this.name=s;this.agentVersion=i;this.connectionType=r}};var w=[];for(let o=0;o<256;++o)w.push((o+256).toString(16).slice(1));function Fe(o,e=0){return(w[o[e+0]]+w[o[e+1]]+w[o[e+2]]+w[o[e+3]]+"-"+w[o[e+4]]+w[o[e+5]]+"-"+w[o[e+6]]+w[o[e+7]]+"-"+w[o[e+8]]+w[o[e+9]]+"-"+w[o[e+10]]+w[o[e+11]]+w[o[e+12]]+w[o[e+13]]+w[o[e+14]]+w[o[e+15]]).toLowerCase()}var Te=require("crypto"),X=new Uint8Array(256),Q=X.length;function Z(){return Q>X.length-16&&((0,Te.randomFillSync)(X),Q=0),X.slice(Q,Q+=16)}var le={};function Ye(o,e,t){let s;if(o)s=$e(o.random??o.rng?.()??Z(),o.msecs,o.seq,e,t);else{let i=Date.now(),r=Z();Be(le,i,r),s=$e(r,le.msecs,le.seq,e,t)}return e??Fe(s)}function Be(o,e,t){return o.msecs??=-1/0,o.seq??=0,e>o.msecs?(o.seq=t[6]<<23|t[7]<<16|t[8]<<8|t[9],o.msecs=e):(o.seq=o.seq+1|0,o.seq===0&&o.msecs++),o}function $e(o,e,t,s,i=0){if(o.length<16)throw new Error("Random bytes length must be >= 16");if(!s)s=new Uint8Array(16),i=0;else if(i<0||i+16>s.length)throw new RangeError(`UUID byte range ${i}:${i+15} is out of buffer bounds`);return e??=Date.now(),t??=o[6]*127<<24|o[7]<<16|o[8]<<8|o[9],s[i++]=e/1099511627776&255,s[i++]=e/4294967296&255,s[i++]=e/16777216&255,s[i++]=e/65536&255,s[i++]=e/256&255,s[i++]=e&255,s[i++]=112|t>>>28&15,s[i++]=t>>>20&255,s[i++]=128|t>>>14&63,s[i++]=t>>>6&255,s[i++]=t<<2&255|o[10]&3,s[i++]=o[11],s[i++]=o[12],s[i++]=o[13],s[i++]=o[14],s[i++]=o[15],s}var ue=Ye;var O=require("child_process");var U=class o{static CONFIG_KEY="edgeos.devices";static CURRENT_DEVICE_KEY="edgeos.currentDevice";_onDevicesChanged=new g.EventEmitter;devices=[];deviceIdsCheckedForUpdates=new Set;currentDevice;onDevicesChanged=this._onDevicesChanged.event;_onCurrentDeviceChanged=new g.EventEmitter;onCurrentDeviceChanged=this._onCurrentDeviceChanged.event;constructor(){}async getDevices(){let s=(g.workspace.getConfiguration().get(o.CONFIG_KEY)||[]).map(i=>new A(i.id,i.address,i.address,void 0,"Custom"));try{let i=await D.create();if(!i)return s;let r=await new Promise((y,f)=>{(0,O.exec)(`${i.path} devices --json`,(m,E)=>{m&&f(m),y(E)})}),n=JSON.parse(r),c=[];for(let y of n.lanDevices)c.push(new A(y.id,y.hostname,y.displayName,y.agentVersion,"LAN"));let h=[...c,...s];this.devices=h;let k=this.getCurrentDevice();return k&&this.checkForUpdates(k),h}catch(i){console.error(i),this.devices=s;let r=this.getCurrentDevice();return r&&this.checkForUpdates(r),s}}getCurrentDeviceId(){return g.workspace.getConfiguration().get(o.CURRENT_DEVICE_KEY)}getCurrentDevice(){let e=this.getCurrentDeviceId();if(!e)return;let t=this.devices.find(s=>s.id===e);return this.currentDevice=t,t}async checkForUpdates(e){if(this.deviceIdsCheckedForUpdates.has(e.id))return;this.deviceIdsCheckedForUpdates.add(e.id);let t=await D.create();if(!t)throw new Error("Failed to create Edge CLI");let s=await new Promise((r,n)=>{(0,O.exec)(`${t.path} agent version --agent ${e.address} --json --check-updates --prerelease`,(c,h)=>{c&&n(c),r(h)})}),i=JSON.parse(s);i.latestVersion&&await g.window.showInformationMessage(`Update available for ${e.name}: ${i.latestVersion}`,"Update")==="Update"&&await this.updateAgent(e.id)}async setCurrentDevice(e){let t=g.workspace.getConfiguration();if(e){let s=this.devices.find(i=>i.id===e);if(!s)throw new Error(`Device with ID ${e} not found`);this.currentDevice=s,this.checkForUpdates(s)}await t.update(o.CURRENT_DEVICE_KEY,e,g.ConfigurationTarget.Global),this._onCurrentDeviceChanged.fire(e),this._onDevicesChanged.fire()}async addDevice(e){let t=g.workspace.getConfiguration(),s=t.get(o.CONFIG_KEY)||[];if(s.some(r=>r.address===e))throw new Error(`Device with address ${e} already exists`);let i={id:ue(),address:e};return s.push(i),await t.update(o.CONFIG_KEY,s,g.ConfigurationTarget.Global),s.length===1?await this.setCurrentDevice(i.id):this._onDevicesChanged.fire(),new A(i.id,i.address,"Edge Agent",void 0,"Custom")}async updateAgent(e){let t=this.devices.find(i=>i.id===e);if(!t)throw new Error(`Device with ID ${e} not found`);let s=await D.create();if(!s)throw new Error("Failed to create Edge CLI");g.window.withProgress({location:g.ProgressLocation.Notification,title:`Updating EdgeOS Agent on ${t.name}`,cancellable:!1},async()=>{try{await new Promise((i,r)=>{(0,O.exec)(`${s.path} agent update --agent ${t.address}`,(n,c)=>{n&&r(n),i(c)})}),this._onDevicesChanged.fire()}catch(i){g.window.showErrorMessage(`Failed to update agent: ${i}`)}})}async connectWifi(e){let i=(g.workspace.getConfiguration().get(o.CONFIG_KEY)||[]).find(f=>f.id===e);if(!i)throw new Error(`Device with ID ${e} not found`);let r=await D.create();if(!r)throw new Error("Failed to create Edge CLI");let n=await new Promise((f,m)=>{(0,O.exec)(`${r.path} wifi list --agent ${i.address} --json`,(E,L)=>{E&&m(E),f(L)})}),c=JSON.parse(n),h=await g.window.showQuickPick(c.map(f=>({label:f.ssid,description:`Signal Strength: ${f.signalStrength}`})),{placeHolder:"Select a WiFi network"});if(!h)return;let k=await g.window.showInputBox({prompt:"Enter the password for the WiFi network",password:!0});if(!k)return;if(n=await new Promise((f,m)=>{(0,O.exec)(`${r.path} wifi connect "${h.label}" --agent ${i.address} --password "${k}" --json`,(E,L,Me)=>{E&&m(E),f(L)})}),!JSON.parse(n).success)throw new Error("Failed to connect to WiFi");g.window.showInformationMessage(`Connected to ${h.label}`)}async deleteDevice(e){let t=g.workspace.getConfiguration(),s=t.get(o.CONFIG_KEY)||[],i=s.filter(n=>n.id!==e);if(i.length===s.length)throw new Error(`Device with ID ${e} not found`);await t.update(o.CONFIG_KEY,i,g.ConfigurationTarget.Global),this.getCurrentDeviceId()===e?i.length>0?await this.setCurrentDevice(i[0].id):await this.setCurrentDevice(void 0):this._onDevicesChanged.fire()}};var Ie=l(require("child_process")),fe="edge",ee=class{constructor(e,t,s){this.cli=e;this.args=t;this.cwd=s}writeEmitter=new p.EventEmitter;onDidWrite=this.writeEmitter.event;closeEmitter=new p.EventEmitter;onDidClose=this.closeEmitter.event;process;open(){this.writeEmitter.fire(`> Executing: ${this.cli.path} ${this.args.join(" ")}\r
`),this.process=Ie.spawn(this.cli.path,this.args,{cwd:this.cwd,stdio:["ignore","pipe","pipe"]}),this.process.stdout?.on("data",e=>{this.writeEmitter.fire(e.toString())}),this.process.stderr?.on("data",e=>{this.writeEmitter.fire(e.toString())}),this.process.on("close",e=>{this.writeEmitter.fire(`\r
Edge process exited with code ${e}\r
`),this.closeEmitter.fire(e||0)}),this.process.on("error",e=>{this.writeEmitter.fire(`\r
Error: ${e.message}\r
`),this.closeEmitter.fire(1)})}close(){this.process&&(this.process.kill(),this.process=void 0)}},te=class o{constructor(e,t){this.workspaceContext=e;this.deviceManager=t||new U,this.edgeCLI=e.cli}deviceManager;edgeCLI;async provideTasks(e){let t=[];for(let s of this.workspaceContext.folders){let i=await s.swift.swiftPackage.executableProducts;for(let r of i)t.push(...this.createRunTasks(r,s))}return t}createRunTasks(e,t){let s={type:fe,args:["run","--detach",e.name],cwd:t.swift.folder},i=new p.Task(s,p.TaskScope.Workspace,`Run ${e.name}`,"edge",new p.CustomExecution(async r=>{let n=[...s.args],c=await this.deviceManager.getCurrentDevice();c&&n.push("--agent",c.address);let h=p.workspace.getConfiguration("edgeos").get("runtime");return h&&n.push("--runtime",h),n.push("--debug"),new ee(this.edgeCLI,n,s.cwd.fsPath)}));return i.group=p.TaskGroup.Build,[i]}async resolveTask(e,t){if(e.definition.type!==fe)return e;let s=e.definition;return new p.Task(s,e.scope||p.TaskScope.Workspace,e.name,e.source,new p.CustomExecution(async i=>{let r=[...s.args],n=await this.deviceManager.getCurrentDevice();return n&&r.push("--agent",n.address),r.push("--debug"),new ee(this.edgeCLI,r,s.cwd.fsPath)}),e.problemMatchers)}static register(e,t){let s=new o(e,t);return p.tasks.registerTaskProvider(fe,s)}};var P=l(require("vscode")),j=class extends P.TreeItem{constructor(t,s,i){super(t,P.TreeItemCollapsibleState.None);this.label=t;this.url=s;this.iconId=i;this.tooltip=`Open ${t}`,this.command={command:"vscode.open",title:"Open Documentation",arguments:[P.Uri.parse(s)]},this.iconPath=new P.ThemeIcon(i),this.contextValue="documentationLink"}},oe=class{_onDidChangeTreeData=new P.EventEmitter;onDidChangeTreeData=this._onDidChangeTreeData.event;documentationLinks=[new j("Visit Website","https://edge.engineer","globe"),new j("Visit Docs","https://edge.engineer","book"),new j("Visit GitHub","https://github.com/edgeengineer","github")];constructor(){}refresh(){this._onDidChangeTreeData.fire()}getTreeItem(e){return e}getChildren(e){return e?Promise.resolve([]):Promise.resolve(this.documentationLinks)}};var T=l(require("vscode"));var R=class{data;onChange;isEquivalent;constructor(e,t){this.data=void 0,this.onChange=e,this.isEquivalent=t}autorefresh(e){e().then(t=>{(!this.data||!this.isEquivalent(this.data,t))&&(this.data=t,this.onChange(t)),setTimeout(()=>{this.autorefresh(e)},5e3)})}};var pe=class extends T.TreeItem{constructor(t,s){super(t.address,T.TreeItemCollapsibleState.None);this.device=t;this.isCurrentDevice=s;this.tooltip=`Agent Version: ${t.agentVersion||"unknown"}`,this.iconPath=new T.ThemeIcon("vm"),this.description=s?`Active (${t.connectionType})`:`(${t.connectionType})`;let i="device";s&&(i+="-current"),i+=`-${t.connectionType}`,this.contextValue=i,this.id=t.id,this.command={command:"edgeDevices.selectDevice",title:"Select Device",arguments:[this]}}},ie=class{constructor(e){this.deviceManager=e;this.deviceManager.onDevicesChanged(()=>{this.refresh()}),this.deviceManager.onCurrentDeviceChanged(()=>{this.refresh()})}_onDidChangeTreeData=new T.EventEmitter;onDidChangeTreeData=this._onDidChangeTreeData.event;refresh(){this._onDidChangeTreeData.fire()}autorefresh(){new R(()=>{this._onDidChangeTreeData.fire()},(t,s)=>t.length===s.length&&t.every((i,r)=>i.id===s[r].id)).autorefresh(()=>this.deviceManager.getDevices())}getTreeItem(e){return e}async getChildren(e){if(e)return Promise.resolve([]);{let t=await this.deviceManager.getDevices(),s=this.deviceManager.getCurrentDeviceId();return t.map(i=>new pe(i,i.id===s))}}};var G=l(require("vscode"));var Le=require("child_process"),se=class{outputChannel;constructor(e){this.outputChannel=e}async getDisks(){let e=await D.create();if(!e)return[];let t=await new Promise((s,i)=>{(0,Le.exec)(`${e.path} imager list --json --all`,(r,n)=>{r&&i(r),s(n)})});return JSON.parse(t)}async flashEdgeOS(e,t){let s=await D.create();s&&await G.window.withProgress({location:G.ProgressLocation.Window,title:"Flashing EdgeOS",cancellable:!0},async(i,r)=>{this.outputChannel.appendLine(`Flashing EdgeOS to disk ${e.id} with image ${t}`);let n=G.window.createTerminal({name:"EdgeOS Flasher",shellPath:s.path,shellArgs:["imager","write-device",t,e.id,"--force"]});n.show(),r.onCancellationRequested(()=>{this.outputChannel.appendLine("Flashing cancelled by user. Closing terminal..."),n.dispose()})})}};var $=l(require("vscode"));var he=class extends $.TreeItem{constructor(t){let s=(t.capacity/1e3/1e3/1e3).toFixed(0)+"GB";super(t.name,$.TreeItemCollapsibleState.None);this.disk=t;this.tooltip=`Disk: ${t.id}`,this.iconPath=new $.ThemeIcon("disk"),this.description=s,this.contextValue="disk"}},re=class{diskManager;_onDidChangeTreeData=new $.EventEmitter;onDidChangeTreeData=this._onDidChangeTreeData.event;constructor(e){this.diskManager=e}getTreeItem(e){return e}refresh(){this._onDidChangeTreeData.fire()}autorefresh(){new R(()=>{this._onDidChangeTreeData.fire()},(t,s)=>t.length===s.length&&t.every((i,r)=>i.id===s[r].id)).autorefresh(()=>this.diskManager.getDisks())}async getChildren(e){let s=(await this.diskManager.getDisks()).filter(i=>!i.id.includes("disk0"));return Promise.resolve(s.map(i=>new he(i)))}};var _e=require("child_process");var ne=class{static async listSupportedDevices(){let e=await D.create();if(!e)return[];let t=await new Promise((i,r)=>{(0,_e.exec)(`${e.path} imager list-devices --json`,(n,c,h)=>{n&&r(n),i(c)})});return JSON.parse(t).map(i=>i.name)}};async function qe(o){try{let e=a.window.createOutputChannel("EdgeOS");o.subscriptions.push(e),e.appendLine("Activating EdgeOS extension for Visual Studio Code..."),o.extensionMode===a.ExtensionMode.Development&&e.show();let t=new U,s=new se(e),i=new ie(t);a.window.registerTreeDataProvider("edgeDevices",i);let r=new re(s);a.window.registerTreeDataProvider("edgeDisks",r),i.autorefresh(),r.autorefresh(),o.subscriptions.push(a.commands.registerCommand("edgeDevices.refreshDevices",()=>{i.refresh()}),a.commands.registerCommand("edgeDevices.addDevice",async()=>{let d=await a.window.showInputBox({placeHolder:"hostname or hostname:port",prompt:"Enter the address of the Edge device"});if(d)try{await t.addDevice(d),a.window.showInformationMessage(`Device ${d} added successfully`)}catch(v){a.window.showErrorMessage(`Failed to add device: ${x(v)}`)}}),a.commands.registerCommand("edgeDevices.deleteDevice",async d=>{if(d?.device&&await a.window.showWarningMessage(`Are you sure you want to remove device ${d.device.address}?`,{modal:!0},"Remove")==="Remove")try{await t.deleteDevice(d.device.id),a.window.showInformationMessage(`Device ${d.device.address} removed`)}catch(b){a.window.showErrorMessage(`Failed to remove device: ${x(b)}`)}}),a.commands.registerCommand("edgeDevices.connectWifi",async d=>{if(d?.device)try{await t.connectWifi(d.device.id)}catch(v){a.window.showErrorMessage(`Failed to connect to WiFi: ${x(v)}`)}}),a.commands.registerCommand("edgeDevices.updateAgent",async d=>{d?.device&&await t.updateAgent(d.device.id)}),a.commands.registerCommand("edgeDevices.selectDevice",async d=>{if(d?.device)try{await t.setCurrentDevice(d.device.id),a.window.showInformationMessage(`${d.device.address} set as current device`)}catch(v){a.window.showErrorMessage(`Failed to set current device: ${x(v)}`)}}),a.commands.registerCommand("edgeDisks.refreshDisks",()=>{r.refresh()}),a.commands.registerCommand("edgeDisks.flashDisk",async d=>{if(!d||!d.disk||!(await a.window.showWarningMessage("This feature will erase all data on the disk. Are you sure you want to continue?",{modal:!0},"No","Yes")==="Yes"))return;let b=await ne.listSupportedDevices(),F=await a.window.showQuickPick(b,{placeHolder:"Select the device type you're flashing",canPickMany:!1});if(F)try{await s.flashEdgeOS(d.disk,F)}catch(ve){a.window.showErrorMessage(`Failed to flash EdgeOS: ${x(ve)}`)}}),a.commands.registerCommand("edge.configureSwiftSdkPath",async()=>{await a.commands.executeCommand("workbench.action.openSettings","edgeos.swiftSdkPath")}));let n=new oe;a.window.registerTreeDataProvider("edgeDocumentation",n),o.subscriptions.push(a.workspace.onDidChangeConfiguration(d=>{d.affectsConfiguration("edgeos.cliPath")&&a.window.showInformationMessage("EdgeOS: CLI path has been changed. Reload window for changes to take effect.","Reload Window").then(b=>{b==="Reload Window"&&a.commands.executeCommand("workbench.action.reloadWindow")})}));let c=a.extensions.getExtension("swiftlang.swift-vscode");if(!c)throw new Error("Swift extension not found");let h=c.packageJSON.version;e.appendLine(`Swift extension version: ${h}`);let k=await c.activate();if(e.appendLine(`Swift API: ${k}`),!k.workspaceContext)throw new Error("Swift API workspace context not found");let y=k.workspaceContext.onDidChangeFolders(async({folder:d,operation:v})=>{if(e.appendLine(`Swift folder change detected: ${v}`),d&&v==="add"&&(e.appendLine(`Folder added: ${d.folder.fsPath}`),await N.isEdgeProject(d.folder.fsPath))){for(let F of m.folders)if(F.swift===d){(a.workspace.getConfiguration("launch",d.folder).get("configurations")||[]).some(Ne=>Ne.type===S)||(await H(F),e.appendLine(`Added Edge debug configurations to new folder ${d.folder.fsPath}`));break}}});o.subscriptions.push(y),e.appendLine("Listening for Swift folder changes...");let f=await D.create();if(!f){let v=a.workspace.getConfiguration("edgeos").get("cliPath"),b=["Configure Path","View Installation Instructions"],F=await a.window.showErrorMessage(v&&v.trim()!==""?`The configured Edge CLI path "${v}" is not accessible or executable.`:"Unable to automatically discover your Edge CLI installation.",...b);F==="Configure Path"?await a.commands.executeCommand("workbench.action.openSettings","edgeos.cliPath"):F==="View Installation Instructions"&&a.env.openExternal(a.Uri.parse("https://github.com/apache-edge/edge-agent/blob/main/README.md"));return}e.appendLine(`Discovered Edge CLI at path: ${f.path}`),e.appendLine(`Edge CLI version: ${f.version}`);let m=new z(o,e,f,k.workspaceContext);o.subscriptions.push(m),o.subscriptions.push(te.register(m,t));let E=J.register(m,e,t);o.subscriptions.push(...E);let L=a.commands.registerCommand("edge.refreshDebugConfigurations",()=>{a.commands.executeCommand("workbench.action.debug.configure")});o.subscriptions.push(L);let me=a.workspace.getConfiguration("edgeos").get("swiftSdkPath");if(!me||me.trim()===""){e.appendLine("Swift SDK path is not set. Debugging may not work properly.");let d=["Configure Now","Later"];a.window.showWarningMessage("EdgeOS Swift SDK path is not set. This is required for debugging EdgeOS applications.",...d).then(v=>{v==="Configure Now"&&a.commands.executeCommand("edge.configureSwiftSdkPath")})}console.log("[Edge] Configuration generation handled by EdgeWorkspaceContext"),e.appendLine("EdgeOS extension activated successfully.")}catch(e){let t=x(e);a.window.showErrorMessage(`Activating Edge extension failed: ${t}`)}}function Je(){}0&&(module.exports={activate,deactivate});
